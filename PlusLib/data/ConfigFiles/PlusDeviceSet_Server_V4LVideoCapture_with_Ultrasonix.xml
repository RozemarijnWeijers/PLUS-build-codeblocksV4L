<PlusConfiguration version="2.0">

  <DataCollection StartupDelaySec="2.0" >
    <DeviceSet 
      Name="PlusServer: Video for Linux video capture device"
      Description="Broadcasting acquired video through OpenIGTLink" />
    
  <Device
      Id="VideoDevice" 
      DeviceName="/dev/video0"
      Channel="0"
      Type="VFLVideo"
      CropHeight="260"
      CropWidth="385"
      CropTop="110"
      CropLeft="285">
      <DataSources>
        <DataSource Type="Video" Id="Video1" PortUsImageOrientation="MF"  />     
      </DataSources>      
      <OutputChannels>
        <OutputChannel Id="VideoStream" VideoDataSourceId="Video1" />
      </OutputChannels>
  </Device>

  <Device
        Id="TrackerDevice"
        Type="OpenIGTLinkTracker"      
        MessageType="TRANSFORM"
        ToolReferenceFrame="Tracker"
        ServerAddress="170.223.221.115"
        ServerPort="18944"
        IgtlMessageCrcCheckEnabled="false" 
	UseReceivedTimestamps="false"
	UseLastTransformsOnReceiveTimeout="true"	
	AcquisitionRate="20">
        <DataSources>
          <DataSource Type="Tool" Id="Probe"  />
        </DataSources>
        <OutputChannels>
          <OutputChannel Id="TrackerStream">
 		<DataSource Id="Probe"/>
	  </OutputChannel>
        </OutputChannels>
  </Device>

  <Device 
      Id="TrackedVideoDevice" 
      Type="VirtualMixer" >
      <InputChannels>
        <InputChannel Id="TrackerStream" />
        <InputChannel Id="VideoStream" />
      </InputChannels>
      <OutputChannels>
        <OutputChannel Id="TrackedVideoStream"/>
      </OutputChannels>
  </Device>

    <Device
      Id="CaptureDevice"
      Type="VirtualDiscCapture"
      BaseFilename="RecordingVolume.mha"
      EnableCapturing="FALSE" >
      <InputChannels>
        <InputChannel Id="TrackedVideoStream" />
      </InputChannels>
    </Device>

    <Device
      Id="VolumeReconstructorDevice"
      Type="VirtualVolumeReconstructor"
      OutputVolDeviceName="RecVol_Reference">
      <InputChannels>
        <InputChannel Id="TrackedVideoStream" />
      </InputChannels>
      <VolumeReconstruction
        ImageCoordinateFrame="Image" 
        ReferenceCoordinateFrame="Reference"
        Interpolation="LINEAR" 
        Optimization="NONE" 
        CompoundingMode="MEAN" 
        FillHoles="OFF" 
        NumberOfThreads="2"
        ClipRectangleOrigin="0 0" 
        ClipRectangleSize="820 616"
        OutputOrigin="-15 -15 30" 
        OutputExtent="0 300 0 300 0 300" 
        OutputSpacing="0.15 0.15 0.15" />
    </Device>

  </DataCollection>

  <CoordinateDefinitions> 
    <Transform From="Image" To="Transducer"
      Matrix="
 	0 0 1 0
	1 0 0 -170
	0 1 0 0     
        0 0 0 1" />
    <Transform From="Transducer" To="Probe"
      Matrix="
 	0 0 1 0
	0 1 0 0
	1 0 0 0     
        0 0 0 1" />
    <Transform From="Reference" To="Tracker"
      Matrix="
 	1 0 0 0
	0 1 0 0
	0 0 1 0     
        0 0 0 1" />
  </CoordinateDefinitions>


  <PlusOpenIGTLinkServer 
    MaxNumberOfIgtlMessagesToSend="1" 
    MaxTimeSpentWithProcessingMs="50" 
    ListeningPort="18944" 
    SendValidTransformsOnly="true" 
    OutputChannelId="TrackedVideoStream" > 
    <DefaultClientInfo> 
      <MessageTypes> 
        <Message Type="IMAGE" />
        <Message Type="TRANSFORM" />
      </MessageTypes>
      <TransformNames>
	<Transform Name="TransducerToReference"/>
      </TransformNames>
      <ImageNames>
        <Image Name="Image" EmbeddedTransformToFrame="Reference" />
      </ImageNames>
    </DefaultClientInfo>
  </PlusOpenIGTLinkServer>
</PlusConfiguration>
