 <PlusConfiguration version="2.1">

  <DataCollection StartupDelaySec="1.0" >
    <DeviceSet 
      Name="PlusServer: Ultrasonix ultrasound imaging device using motorized probe"
      Description="Broadcasting ultrasound images acquired from the Ultrasonix system through OpenIGTLink. Update PortaFirmwarePath, PortaSettingPath, PortaLicensePath, PortaLUTPath attributes in the device set configuration file. PlusServer has to run on the Ultrasonix PC. The Ultrasonix Exam software must NOT be running (as the Porta interface is used)."
    />
    <Device
      Id="VideoDevice"
      Type="SonixPortaVideo" 
      AcquisitionRate="30" 
      BModeFrameSize="480 436"
      Depth="70" 
      Gain="50" 
      Frequency="3.3" 
      FramePerVolume="83"
      StepPerFrame="4"
      PortaFirmwarePath="D:/Users/Mikael/sdk574/porta/fw/"
      PortaSettingPath="D:/Users/Mikael/sdk574/porta/dat/"
      PortaLicensePath="D:/Ultrasonix Settings/"
      PortaLUTPath="D:/Ultrasonix Settings/LUTS/"
      Usm="4"
      Pci="3"
      HighVoltage="0"
      Channels="64"
      >
      <DataSources>
        <DataSource Type="Video" Id="Video" PortName="B" PortUsImageOrientation="UF"  />
      </DataSources>
      <OutputChannels>
        <OutputChannel Id="VideoStream" VideoDataSourceId="Video" />
      </OutputChannels>
    </Device>
    <Device
      Id="CaptureDevice"
      Type="VirtualDiscCapture"
      BaseFilename="RecordingTest.mha"
      EnableCapturing="FALSE" >
      <InputChannels>
        <InputChannel Id="VideoStream" />
      </InputChannels>
    </Device>
  
    <Device
      Id="VolumeReconstructorDevice"
      Type="VirtualVolumeReconstructor"
      OutputVolDeviceName="RecVol_Ras">
      <InputChannels>
        <InputChannel Id="VideoStream" />
      </InputChannels>
      <VolumeReconstruction
        ImageCoordinateFrame="Image" ReferenceCoordinateFrame="Ras"
        Interpolation="LINEAR" Optimization="FULL" CompoundingMode="MEAN" NumberOfThreads="2"
        ClipRectangleOrigin="0 0" ClipRectangleSize="480 436"
        OutputOrigin="-50 -100 -56" OutputExtent="0 200 0 160 0 224" OutputSpacing="0.5 0.5 0.5" 
        FillHoles="ON" >
    <HoleFilling>
      <HoleFillingElement Type="GAUSSIAN" Size="5" Stdev="0.6667" MinimumKnownVoxelsRatio="0.50001" />
      <HoleFillingElement Type="STICK" StickLengthLimit="9" NumberOfSticksToUse="1" />
    </HoleFilling>
    </VolumeReconstruction>
    </Device>
  </DataCollection>

  <CoordinateDefinitions>
    <Transform From="Transducer" To="Image"
      Matrix="
        4.344 0   0   240
        0   5.051 0   44
        0   0     4.7  0
        0   0   0   1" />
    <Transform From="MotorRotated" To="Transducer"
      Matrix="
        1 0 0 0
        0 1 0 -27.25
        0 0 1 0
        0 0 0 1" /> 
    <Transform From="Ras" To="Motor"
      Matrix="
        0 0 1 0
        0 -1  0 0
        1 0 0 0
        0 0 0 1" />   
  </CoordinateDefinitions>
  
  <PlusOpenIGTLinkServer 
    MaxNumberOfIgtlMessagesToSend="1" 
    MaxTimeSpentWithProcessingMs="50" 
    ListeningPort="18944" 
    SendValidTransformsOnly="true" 
    OutputChannelId="VideoStream" > 
    <DefaultClientInfo> 
      <MessageTypes> 
        <Message Type="IMAGE" />
        <Message Type="TRANSFORM" />
        <Message Type="STRING" />
      </MessageTypes>
      <TransformNames> 
        <Transform Name="MotorToRas" />
        <Transform Name="DummyToVolumeIndex" />
      </TransformNames>
      <ImageNames>
        <Image Name="Image" EmbeddedTransformToFrame="Ras" />
      </ImageNames>
      <StringNames>
        <String Name="FrameNumber" />
        <String Name="VolumeIndex" />
        <String Name="MotorAngleDeg" />
      </StringNames>
    </DefaultClientInfo>
  </PlusOpenIGTLinkServer>

</PlusConfiguration>
